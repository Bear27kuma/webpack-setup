# Webpackによる環境構築
## 使用するパッケージマネージャー
- npm
- yarn

どちらもNode.jsで動作するパッケージマネージャーで、コンピュータに何のソフトウェアがインストールされたかを記録し、新しいソフトウェアのインストールや更新、以前インストールしたソフトウェアの削除などが容易に行えるプログラム

## webpackとwebpack-cliのインストール
`npm install webpack webpack-cli --dev`で各パッケージをインストール

`--dev`をつけると開発環境用にインストールする

## webpackの実行
`npx webpck`で実行もしくは、`package.json`のscriptsに`"webpack": "webpack"`を記述した上で`npm run webpack`を実行する

実行モードは`development`と`production`があるが、`development`にするとデバッグがしやすいように圧縮されずにバンドルされる

## webpackの設定ファイル
通常は毎回コマンドを叩くわけにもいかないので、`webpack.config.js`を作成して、そちらにバンドルに関する設定を記述する
こちらに記載した設定を`webpack`コマンドを実行した際に自動的に読み込んでバンドルしてくれるようになる

Node環境なので、CommonJSの`module.exports`を使ってエクスポートする


主なオプション

| オプション名 | 内容 |
| ----- | ----- |
| `entry` | エントリーポイントという全てのファイルの基準となるファイルを指定する<br>Webpackのエントリーポイントは`src/app.js`がデフォルトで指定されている<br>インポートしたモジュールファイルも一緒にバンドルされる<br>複数存在する場合は配列にして設定するとまとめて1ファイルにバンドルしてくれる<br>オブジェクトリテラルで記述すると出力先ファイルを分けることもできる |
| `output` | 出力先のファイルとフォルダを指定する（デフォルトの設定は`dist`ディレクトリと`main.js`）<br>`path`の設定は絶対参照なので、`path`モジュールを`require`して使用する<br>`filename`ではファイル名を変更する（`[name]`は`entry`でオブジェクトリテラルを指定した場合のキーが入ってくる） |

## Sassファイルをバンドルする
必要なパッケージをインストールする

| パッケージ名 | 役割 |
| ----- | ----- |
| sass | Sass本体 |
| sass-loader | SassファイルをCSSに変関するツールを呼び出す |
| css-loader | CSSファイルをJSモジュール用に変換する |
| style-loader | CSSをstyleタグでHTMLに埋め込む |

webpack.config.js
```js
{
  module: {
    rules: [
      {
        // 対象となる拡張子
        test: /\*.scss$/,
        // どのloaderを使用するか
        use: [
          // 下から実行されるため、最初に実行したいものを末尾に記述
          'style-loader',
          'css-loader',
          'sass-loader'
        ]
      }
    ]
  }
};
```

バンドルするには.scssファイルを`app.js`に読み込む必要がある

実際にバンドルされた情報がブラウザに配信され、その後style-loaderを通してstyleタグとしてHTMLファイルにインジェクト（注入）される

## PostCSSでより実践的なCSSローダーを作成
PostCSSとはCSSを操作するためのJavaScriptプラグインで、PostCSSの機能を使うとベンダープレフィックスの追加や構文チェック、圧縮などを行ってくれる

`autoprefixer`というプラグインではベンダープレフィックスを自動で付与してくれる

`postcss.config.js`という設定ファイルが必要
```js
module.exports = {
  plugins: [
    // autoprefixerを使用するよう設定
    require('autoprefixer')
  ] 
};
```

対応するブラウザリストの設定ファイル（`.browserlistrc`）を追加

## 画像などのアセットファイルをバンドルする
画像などのファイルに関しては以前は`file-loader`をインストールしてバンドル設定を行わないと、画像を読み込んでいる場合はエラーになったが、Webpack5からは標準でAsset Modulesという機能が追加されて対応するようになったので、インストール不要になった

画像のURLはデフォルトではハッシュ値になるので、buildして吐き出される画像の名前が元の名前とは異なるものになる。

```js
{
  // Webpack5からはfile-loaderはインストール不要になったので、loaderの設定はしない
  test: /\.(jpg?g|gif|png|svg|woff2?|tff|eot)$/,
  generator: {
    // 出力先の指定
    filename: './images/[contenthash].[ext]]'
  },
  // アセットモジュールタイプの指定（個別にファイルを生成して、そのURLを出力する
  type: 'asset/resource'
}
```

## ブラウザキャッシュとハッシュについて
端的に言うとウェブサイトの表示を高速化するためにハッシュをつけている

ウェブサイトを初回ロードした時に、ウェブサーバーから全てのファイル（CSSファイル、JSファイル、画像ファイルなど）がクライアント（ユーザー）の使っているブラウザに配信されるが、2回目以降は変更点のないものに関してはブラウザのローカルメモリやディスクに保存しているものをサーバー上に取得しに行かずに表示している（**キャッシュ**）

このように変更点がないものはローカルにストレージしているファイルを表示することで、表示の高速化を図っている

ページ内容を更新した際に、同じファイル名だとブラウザ側が変更を認識できずにローカルからファイルを持ってきて、変更が反映されない場合があるため、**ハッシュ値**を用いることでファイルに変更があったことをブラウザに示せる

Webpackの場合はファイル名自体をハッシュ値で出力するのが一般的


[Webpack - Output/Template String](https://webpack.js.org/configuration/output/#template-strings)

Outputのテンプレートに使えるハッシュは以下の3つ

| テンプレート | 説明 |
| ----- | ----- |
| `fullhash`（`hash`） | ビルド毎につくビルド番号をハッシュ値としてつける<br>複数ファイルに出力する場合は同じハッシュ値がつく<br>データが更新されるたびに全てのファイルのハッシュ値が更新されてしまう |
| `contenthash` | 生成されたファイル毎につく一意のハッシュ値<br>ファイルに変更があればハッシュ値が変わる<br>画像ファイルなどのアセットファイルによく使われる |
| `chunkhash` | 生成されたファイル毎につくハッシュ値で、chunkという単位で割り振られる |
